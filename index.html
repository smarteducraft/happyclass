<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Class (V3.11)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body {
            font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            overflow: hidden;
            transition: background 0.5s ease;
        }
        .glass {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .text-shadow-lg { text-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.1); }
        .text-shadow-strong { text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .bg-default { background: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%); }
        .card-anim { transition: all 0.2s ease; }
        #bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-size: cover; background-position: center;
        }
        .left-content-shadow { background: linear-gradient(to right, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        
        .editable-input { background: transparent; border: none; outline: none; width: 100%; padding: 2px 0; }
        .editable-input:focus { background: rgba(255,255,255,0.5); border-radius: 4px; }
        
        #notice-textarea { 
            background: transparent; border: none; outline: none; resize: none; 
            width: 100%; height: 100%; font-size: 2.2rem; line-height: 1.6; 
            color: #334155; font-weight: 800; 
        }
        #notice-textarea::placeholder { color: rgba(51, 65, 85, 0.2); font-weight: 700; }

        /* Album Slide Effect */
        #album-image {
            transition: opacity 0.8s ease-in-out;
            opacity: 1;
        }
        .fade-out { opacity: 0 !important; }

        .loader { 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #f97316; 
            border-radius: 50%; 
            width: 30px; height: 30px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Accent for shuffle active */
        .btn-active { color: #f97316 !important; background: rgba(249, 115, 22, 0.1); border-radius: 50%; }
    </style>
</head>
<body class="bg-default text-slate-800 h-screen flex items-center justify-center p-6">
    <div id="bg-container" class="bg-default"></div>

    <main class="w-full h-full flex gap-4 z-10">
        <!-- ì¢Œì¸¡ ì˜ì—­ -->
        <section class="w-[38%] flex flex-col justify-between py-10 pl-6 pr-4 left-content-shadow text-shadow-lg">
            <div class="space-y-2">
                <div id="date-display" class="text-3xl font-bold tracking-tight text-slate-700 opacity-90 text-nowrap">2026. 02. 28</div>
                <div id="day-display" class="text-6xl font-black text-orange-500 text-shadow-strong">í† ìš”ì¼</div>
            </div>

            <div class="flex flex-col gap-0">
                <div class="flex flex-col items-start">
                    <span id="ampm-display" class="text-4xl font-bold text-blue-500 mb-2">ì˜¤ì „</span>
                    <div class="flex items-baseline">
                        <span id="time-display" class="text-[10rem] font-black leading-none tracking-tighter text-slate-800 text-shadow-strong">07:35</span>
                        <span class="text-4xl font-bold opacity-50 ml-4">: <span id="sec-display">28</span></span>
                    </div>
                </div>
            </div>

            <div class="space-y-3 flex flex-col items-start">
                <div id="status-badge" class="glass inline-block px-8 py-4 rounded-3xl text-3xl font-black shadow-xl border-white/50 mb-2">ì•„ì¹¨ììŠµ</div>
                <div id="dday-container" class="flex flex-wrap gap-2 max-w-full"></div>
            </div>
        </section>

        <!-- ìš°ì¸¡ ì˜ì—­ -->
        <section class="w-[62%] flex flex-col p-4">
            <div class="flex justify-between items-end mb-8">
                <div class="flex items-end gap-4 overflow-x-auto custom-scrollbar pb-1">
                    <div>
                        <h2 id="right-title" class="text-5xl font-black text-orange-600 mb-1 text-shadow-lg text-nowrap">Happy Class</h2>
                        <p id="right-subtitle" class="text-lg font-bold tracking-widest text-slate-500 opacity-70 uppercase">Smart Dashboard</p>
                    </div>
                    <!-- íƒ­ ì „í™˜ ë²„íŠ¼ -->
                    <div class="flex bg-white/30 p-1 rounded-xl backdrop-blur-sm border border-white/40 mb-1 flex-nowrap">
                        <button onclick="toggleView('rules')" id="btn-view-rules" class="px-4 py-2.5 rounded-lg font-bold transition-all text-sm text-nowrap">ì•½ì†</button>
                        <button onclick="toggleView('notice')" id="btn-view-notice" class="px-4 py-2.5 rounded-lg font-bold transition-all text-sm text-nowrap">ì•Œë¦¼ì¥</button>
                        <button onclick="toggleView('announcements')" id="btn-view-announcements" class="px-4 py-2.5 rounded-lg font-bold transition-all text-sm text-nowrap">ê³µì§€ì‚¬í•­</button>
                        <button onclick="toggleView('meal')" id="btn-view-meal" class="px-4 py-2.5 rounded-lg font-bold transition-all text-sm text-nowrap">ê¸‰ì‹</button>
                        <button onclick="toggleView('album')" id="btn-view-album" class="px-4 py-2.5 rounded-lg font-bold transition-all text-sm text-nowrap">ì•¨ë²”</button>
                    </div>
                </div>
                
                <!-- ìš°ì¸¡ ìƒë‹¨ ê¸°ëŠ¥ ë²„íŠ¼ -->
                <div class="flex items-end gap-3 pb-1">
                    <div id="auto-save-indicator" class="flex items-center gap-2 px-2 py-2.5 text-slate-400 font-bold transition-all opacity-0">
                        <i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>
                    </div>

                    <!-- ìŒì•… ì»¨íŠ¸ë¡¤ -->
                    <div class="flex items-center gap-1 bg-white/40 backdrop-blur-md rounded-full px-3 py-1 shadow-lg border border-white/40">
                        <button onclick="playPrev()" class="p-1.5 hover:scale-110 transition-all text-slate-600">
                            <i data-lucide="skip-back" class="w-5 h-5"></i>
                        </button>
                        <button id="music-play-btn" onclick="toggleMusic()" class="p-2 hover:scale-110 transition-all text-orange-500">
                            <i data-lucide="play" id="music-icon" class="w-7 h-7"></i>
                        </button>
                        <button onclick="playNext()" class="p-1.5 hover:scale-110 transition-all text-slate-600">
                            <i data-lucide="skip-forward" class="w-5 h-5"></i>
                        </button>
                        <button id="music-shuffle-btn" onclick="toggleShuffle()" class="p-1.5 hover:scale-110 transition-all text-slate-400 ml-1">
                            <i data-lucide="shuffle" class="w-5 h-5"></i>
                        </button>
                        <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.5" class="w-10 h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-orange-500 mx-2" oninput="setVolume(this.value)">
                    </div>

                    <!-- ì„¤ì • ë²„íŠ¼ -->
                    <button onclick="openSettings()" class="p-3 bg-white/40 backdrop-blur-md rounded-full hover:bg-white/70 transition-all shadow-lg border border-white/40">
                        <i data-lucide="settings" class="w-8 h-8 text-slate-700"></i>
                    </button>
                </div>
            </div>

            <!-- ë‚´ìš© ì»¨í…Œì´ë„ˆ -->
            <div id="content-display-area" class="flex-1 overflow-y-auto pr-2 custom-scrollbar"></div>
            <div class="h-8"></div>
        </section>
    </main>

    <!-- í™˜ê²½ ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 hidden items-start justify-center z-50 p-4 backdrop-blur-sm overflow-y-auto" onclick="handleOutsideClick(event)">
        <div class="bg-white rounded-[2.5rem] w-full max-w-4xl my-8 p-10 shadow-2xl relative" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div class="flex items-center gap-3">
                    <i data-lucide="sliders" class="text-orange-500 w-8 h-8"></i>
                    <h3 class="text-3xl font-black text-slate-800">í™˜ê²½ ì„¤ì •</h3>
                </div>
                <button onclick="closeSettings()" class="p-2 hover:bg-slate-100 rounded-full text-slate-400 transition-colors"><i data-lucide="x" class="w-8 h-8"></i></button>
            </div>

            <div class="space-y-8 pb-4">
                <!-- ë¯¸ë””ì–´ ì„¤ì • -->
                <div class="space-y-3 bg-orange-50 p-5 rounded-2xl border border-orange-100">
                    <h4 class="font-bold text-lg flex items-center gap-2 text-orange-700"><i data-lucide="play-circle" class="w-5 h-5"></i> ì•¨ë²” ë° ìŒì•… ì„¤ì •</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <button onclick="document.getElementById('album-folder-input').click()" class="w-full flex items-center justify-center gap-2 p-3 bg-white border border-orange-200 text-orange-600 rounded-xl font-bold hover:bg-orange-100 transition-all">
                                <i data-lucide="folder-open" class="w-5 h-5"></i> ì‚¬ì§„ í´ë” ì„ íƒ
                            </button>
                            <input type="file" id="album-folder-input" webkitdirectory directory multiple class="hidden" onchange="handleAlbumFiles(this)">
                            <p id="album-status-msg" class="text-xs text-slate-400 text-center font-bold">ì„ íƒëœ ì‚¬ì§„ ì—†ìŒ</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('music-folder-input').click()" class="flex-1 flex items-center justify-center gap-2 p-3 bg-white border border-orange-200 text-orange-600 rounded-xl font-bold text-sm hover:bg-orange-100 transition-all">
                                    <i data-lucide="folder-open" class="w-4 h-4"></i> ìŒì•… í´ë” ì„ íƒ
                                </button>
                                <button onclick="document.getElementById('music-file-input').click()" class="flex-1 flex items-center justify-center gap-2 p-3 bg-white border border-orange-200 text-orange-600 rounded-xl font-bold text-sm hover:bg-orange-100 transition-all">
                                    <i data-lucide="music" class="w-4 h-4"></i> ìŒì•… íŒŒì¼ ì„ íƒ
                                </button>
                            </div>
                            <input type="file" id="music-folder-input" webkitdirectory directory multiple class="hidden" onchange="loadMusic(this)">
                            <input type="file" id="music-file-input" accept="audio/*" multiple class="hidden" onchange="loadMusic(this)">
                            <p id="music-status-msg" class="text-xs text-slate-400 text-center font-bold truncate">ì„ íƒëœ ìŒì•… ì—†ìŒ</p>
                        </div>
                    </div>
                </div>

                <!-- ê¸‰ì‹ í•™êµ ì„¤ì • -->
                <div class="space-y-3 bg-blue-50 p-5 rounded-2xl border border-blue-100">
                    <h4 class="font-bold text-lg flex items-center gap-2 text-blue-700"><i data-lucide="utensils" class="w-5 h-5"></i> ìš°ë¦¬ í•™êµ ê¸‰ì‹ ì„¤ì •</h4>
                    <div class="flex gap-3">
                        <select id="region-select" class="p-3 border rounded-xl font-bold text-base focus:ring-2 focus:ring-blue-400 outline-none w-32">
                            <option value="B10">ì„œìš¸</option><option value="C10">ë¶€ì‚°</option><option value="D10">ëŒ€êµ¬</option>
                            <option value="E10">ì¸ì²œ</option><option value="F10">ê´‘ì£¼</option><option value="G10">ëŒ€ì „</option>
                            <option value="H10">ìš¸ì‚°</option><option value="I10">ì„¸ì¢…</option><option value="J10" selected>ê²½ê¸°</option>
                            <option value="K10">ê°•ì›</option><option value="M10">ì¶©ë¶</option><option value="N10">ì¶©ë‚¨</option>
                            <option value="P10">ì „ë¶</option><option value="Q10">ì „ë‚¨</option><option value="R10">ê²½ë¶</option>
                            <option value="S10">ê²½ë‚¨</option><option value="T10">ì œì£¼</option>
                        </select>
                        <div class="relative flex-1">
                            <input type="text" id="school-name-search" placeholder="í•™êµ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 border rounded-xl font-bold text-base focus:ring-2 focus:ring-blue-400 outline-none">
                            <button onclick="searchSchoolInSettings()" class="absolute right-2 top-2 bg-blue-600 text-white px-4 py-1.5 rounded-lg font-bold text-sm">ê²€ìƒ‰</button>
                        </div>
                    </div>
                    <div id="school-search-results" class="space-y-2 mt-2 max-h-40 overflow-y-auto custom-scrollbar"></div>
                    <div id="selected-school-info" class="text-sm font-bold text-blue-600 mt-1"></div>
                </div>

                <!-- D-Day ê´€ë¦¬ -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-xl flex items-center gap-2 text-slate-700"><i data-lucide="calendar-check" class="w-6 h-6"></i> D-Day ê´€ë¦¬</h4>
                        <button onclick="addRow('dday-editor')" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-xl text-sm font-bold border border-blue-100">+ ì¶”ê°€</button>
                    </div>
                    <div id="dday-editor" class="space-y-3"></div>
                </div>

                <!-- ìˆ˜ì—… ì„¤ì • (ìš”ì¼ë³„ ì‹œìˆ˜) -->
                <div class="space-y-4 bg-slate-50 p-5 rounded-2xl border border-slate-200">
                    <h4 class="font-bold text-xl flex items-center gap-2 text-slate-700"><i data-lucide="layout-list" class="w-6 h-6"></i> ìš”ì¼ë³„ ìˆ˜ì—… ì‹œìˆ˜</h4>
                    <div class="grid grid-cols-5 gap-4">
                        <div class="text-center space-y-1"><span class="text-sm font-bold text-slate-400">ì›”ìš”ì¼</span><select id="period-mon" class="w-full p-2 border rounded-xl text-lg font-black text-center"></select></div>
                        <div class="text-center space-y-1"><span class="text-sm font-bold text-slate-400">í™”ìš”ì¼</span><select id="period-tue" class="w-full p-2 border rounded-xl text-lg font-black text-center"></select></div>
                        <div class="text-center space-y-1"><span class="text-sm font-bold text-slate-400">ìˆ˜ìš”ì¼</span><select id="period-wed" class="w-full p-2 border rounded-xl text-lg font-black text-center text-blue-600"></select></div>
                        <div class="text-center space-y-1"><span class="text-sm font-bold text-slate-400">ëª©ìš”ì¼</span><select id="period-thu" class="w-full p-2 border rounded-xl text-lg font-black text-center"></select></div>
                        <div class="text-center space-y-1"><span class="text-sm font-bold text-slate-400">ê¸ˆìš”ì¼</span><select id="period-fri" class="w-full p-2 border rounded-xl text-lg font-black text-center"></select></div>
                    </div>
                </div>

                <!-- ì‹œì •í‘œ ê¸°ì¤€ ì„¤ì • -->
                <div class="space-y-4 bg-slate-50 p-5 rounded-2xl border border-slate-200">
                    <h4 class="font-bold text-xl flex items-center gap-2 text-slate-700"><i data-lucide="clock" class="w-6 h-6"></i> ì‹œì •í‘œ ì„¤ì • ê¸°ì¤€</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-bold text-slate-500 ml-1">1êµì‹œ ì‹œì‘ ì‹œê°„</label>
                            <input type="time" id="start-time-trigger" class="w-full p-3 border rounded-xl text-xl font-black outline-none focus:ring-2 focus:ring-orange-400" onchange="autoCalculateSchedule(this.value, document.getElementById('lunch-after-input').value)">
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-bold text-slate-500 ml-1">ì ì‹¬ì‹œê°„ ìœ„ì¹˜</label>
                            <select id="lunch-after-input" class="w-full p-3 border rounded-xl text-xl font-black outline-none focus:ring-2 focus:ring-blue-400" onchange="autoCalculateSchedule(document.getElementById('start-time-trigger').value, this.value)">
                                <option value="1">1êµì‹œ í›„ ì ì‹¬</option><option value="2">2êµì‹œ í›„ ì ì‹¬</option>
                                <option value="3">3êµì‹œ í›„ ì ì‹¬</option><option value="4" selected>4êµì‹œ í›„ ì ì‹¬</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ì‹œì •í‘œ ìƒì„¸ ì—ë””í„° -->
                <div class="space-y-4">
                    <h4 class="font-bold text-xl text-slate-700 ml-1">ì‹œì •í‘œ ë‚´ìš© í™•ì¸ ë° ìˆ˜ì •</h4>
                    <div id="schedule-editor" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                </div>
            </div>

            <div class="mt-8 border-t pt-8">
                <button onclick="saveSettings()" class="w-full py-5 bg-orange-500 text-white rounded-2xl font-black text-2xl shadow-xl hover:bg-orange-600 active:scale-[0.98] transition-all">ì„¤ì • ì €ì¥ ë° ì ìš©</button>
            </div>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ ìš”ì†Œ -->
    <audio id="bgm-audio"></audio>
    <audio id="chime-audio" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const NEIS_API_KEY = ""; 
        const NEIS_BASE_URL = "https://open.neis.go.kr/hub";

        let config = {
            viewMode: 'rules',
            notices: {},
            background: { type: 'default', value: '' },
            lunchAfter: 4,
            schoolInfo: null,
            isShuffle: false,
            ddays: [{ text: 'ì—¬ë¦„ë°©í•™', date: '2026-07-31' }],
            rules: [{ title: 'ì„œë¡œ ì¡´ì¤‘í•˜ê¸°', desc: 'ì¹œêµ¬ì˜ ë§ì— ê·€ ê¸°ìš¸ì´ê³ , ë‹¤ë¦„ì„ ì¸ì •í•´ìš”' }, { title: 'ìˆ˜ì—…ì— ì§‘ì¤‘í•˜ê¸°', desc: 'ê²½ì²­í•˜ê³  ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•´ìš”' }],
            announcements: [{ title: 'ì˜¤ëŠ˜ì˜ ë‚ ì”¨', desc: 'ë¯¸ì„¸ë¨¼ì§€ í™•ì¸ í›„ ë§ˆìŠ¤í¬ë¥¼ ì°©ìš©í•˜ì„¸ìš”' }],
            dailyPeriods: { 1: 6, 2: 6, 3: 5, 4: 6, 5: 6 },
            schedule: []
        };

        let mealDate = new Date();
        let noticeDate = new Date();
        let albumPhotos = []; 
        let albumIdx = 0;
        let albumInterval = null;
        let musicPlaylist = [];
        let currentMusicIdx = 0;

        const saved = localStorage.getItem('happy_class_config_v3_11');
        if (saved) config = { ...config, ...JSON.parse(saved) };
        if (!config.schedule || config.schedule.length === 0) config.schedule = generateDefaultSchedule('09:00', config.lunchAfter);

        const audioChime = document.getElementById('chime-audio');
        const audioBgm = document.getElementById('bgm-audio');

        function init() {
            lucide.createIcons();
            applyBackground();
            renderContent();
            renderPeriodSelectors();
            updateTime();
            setInterval(updateTime, 1000);
            
            audioBgm.onended = () => { playNext(); };
            if (config.isShuffle) {
                document.getElementById('music-shuffle-btn')?.classList.add('btn-active');
            }
        }

        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const date = String(now.getDate()).padStart(2, '0');
            const dayNames = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
            const dayIdx = now.getDay();
            
            document.getElementById('date-display').innerText = `${year}. ${month}. ${date}`;
            document.getElementById('day-display').innerText = dayNames[dayIdx];

            let h = now.getHours() % 12 || 12;
            const ampm = now.getHours() >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
            document.getElementById('ampm-display').innerText = ampm;
            document.getElementById('time-display').innerText = `${String(h).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            document.getElementById('sec-display').innerText = String(now.getSeconds()).padStart(2,'0');

            updateStatus(now, dayIdx, `${month}-${date}`);
            updateDday(now);
        }

        function updateStatus(now, dayIdx, monthDay) {
            const currentTime = now.getHours() * 60 + now.getMinutes();
            let status = "Happy Ready";
            const HOLIDAYS = ['01-01', '03-01', '05-05', '06-06', '08-15', '10-03', '10-09', '12-25'];
            
            if (dayIdx === 0 || dayIdx === 6) status = "ì£¼ë§";
            else if (HOLIDAYS.includes(monthDay)) status = "ê³µíœ´ì¼";
            else {
                const max = config.dailyPeriods[dayIdx] || 6;
                let found = false;
                for (const item of config.schedule) {
                    const match = item.name.match(/(\d)êµì‹œ/);
                    if (match && parseInt(match[1]) > max) continue;
                    const [sH, sM] = item.start.split(':').map(Number);
                    const [eH, eM] = item.end.split(':').map(Number);
                    if (currentTime >= (sH * 60 + sM) && currentTime < (eH * 60 + eM)) {
                        status = item.name; found = true; break;
                    }
                }
                if (!found && currentTime >= 480) status = "ë°©ê³¼í›„ ì‹œê°„";
            }
            const badge = document.getElementById('status-badge');
            if (badge) {
                badge.innerText = status;
                badge.className = (status === "ì£¼ë§" || status === "ê³µíœ´ì¼") 
                    ? "glass inline-block px-8 py-4 rounded-3xl text-3xl font-black shadow-xl border-white/50 text-red-500 mb-2"
                    : `glass inline-block px-8 py-4 rounded-3xl text-3xl font-black shadow-xl border-white/50 mb-2 ${status.includes('êµì‹œ') ? 'text-orange-600' : 'text-blue-600'}`;
            }
        }

        function updateDday(now) {
            const container = document.getElementById('dday-container');
            if(!container) return;
            container.innerHTML = '';
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            config.ddays.forEach(item => {
                const target = new Date(item.date);
                target.setHours(0,0,0,0);
                const diff = target - today;
                const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                if (days >= 0) {
                    const el = document.createElement('div');
                    el.className = "bg-white/60 backdrop-blur-sm px-4 py-2 rounded-2xl border border-white/40 shadow-sm text-lg font-bold text-slate-700";
                    el.innerText = days === 0 ? `ì˜¤ëŠ˜: ${item.text} ğŸˆ` : `${item.text} D-${days}`;
                    container.appendChild(el);
                }
            });
        }

        /* ë¯¸ë””ì–´ ê¸°ëŠ¥ */
        function startAlbum() {
            if (albumInterval) clearInterval(albumInterval);
            if (albumPhotos.length > 0) {
                albumInterval = setInterval(() => {
                    albumIdx = (albumIdx + 1) % albumPhotos.length;
                    const img = document.getElementById('album-image');
                    if (img) {
                        img.classList.add('fade-out');
                        setTimeout(() => {
                            img.src = albumPhotos[albumIdx];
                            img.classList.remove('fade-out');
                        }, 800);
                    }
                }, 5000);
            }
        }
        function stopAlbum() { if (albumInterval) clearInterval(albumInterval); }
        
        function handleAlbumFiles(input) {
            const files = Array.from(input.files).filter(f => f.type.startsWith('image/'));
            if (files.length === 0) return;
            albumPhotos = files.map(f => URL.createObjectURL(f));
            albumIdx = 0;
            document.getElementById('album-status-msg').innerText = `${files.length}ì¥ì˜ ì‚¬ì§„ ì„ íƒë¨`;
            if (config.viewMode === 'album') renderContent();
        }

        function toggleMusic() {
            if (musicPlaylist.length === 0) { openSettings(); return; }
            if (audioBgm.paused) {
                if (!audioBgm.src && musicPlaylist.length > 0) playTrack(0);
                else audioBgm.play();
                document.getElementById('music-icon').setAttribute('data-lucide', 'pause'); 
            } else {
                audioBgm.pause(); 
                document.getElementById('music-icon').setAttribute('data-lucide', 'play');
            }
            lucide.createIcons();
        }

        function playNext() {
            if (musicPlaylist.length === 0) return;
            if (config.isShuffle) currentMusicIdx = Math.floor(Math.random() * musicPlaylist.length);
            else currentMusicIdx = (currentMusicIdx + 1) % musicPlaylist.length;
            playTrack(currentMusicIdx);
        }

        function playPrev() {
            if (musicPlaylist.length === 0) return;
            currentMusicIdx = (currentMusicIdx - 1 + musicPlaylist.length) % musicPlaylist.length;
            playTrack(currentMusicIdx);
        }

        function toggleShuffle() {
            config.isShuffle = !config.isShuffle;
            const btn = document.getElementById('music-shuffle-btn');
            if (config.isShuffle) btn?.classList.add('btn-active');
            else btn?.classList.remove('btn-active');
            saveToLocal();
        }

        function loadMusic(input) {
            const files = Array.from(input.files).filter(f => f.type.startsWith('audio/'));
            if (files.length === 0) return;
            musicPlaylist = files.map(f => ({ url: URL.createObjectURL(f), name: f.name }));
            currentMusicIdx = 0;
            playTrack(0);
            document.getElementById('music-status-msg').innerText = files.length > 1 ? `${files.length}ê³¡ ì„ íƒë¨` : files[0].name;
        }

        function playTrack(idx) {
            if (!musicPlaylist[idx]) return;
            audioBgm.src = musicPlaylist[idx].url;
            audioBgm.play().catch(e => console.log(e));
            document.getElementById('music-icon').setAttribute('data-lucide', 'pause');
            lucide.createIcons();
        }

        function setVolume(val) { audioBgm.volume = val; }

        /* ê¸‰ì‹ ë° ì•Œë¦¼ì¥ */
        async function fetchNEIS(endpoint, params) { 
            const q = new URLSearchParams({ Type:'json', KEY:NEIS_API_KEY, ...params }); 
            const r = await fetch(`${NEIS_BASE_URL}/${endpoint}?${q}`); 
            return await r.json(); 
        }

        async function getMealData() {
            if (!config.schoolInfo) return null;
            const ymd = mealDate.getFullYear() + String(mealDate.getMonth() + 1).padStart(2, '0') + String(mealDate.getDate()).padStart(2, '0');
            try { 
                const data = await fetchNEIS('mealServiceDietInfo', { ATPT_OFCDC_SC_CODE: config.schoolInfo.atptCode, SD_SCHUL_CODE: config.schoolInfo.schulCode, MLSV_YMD: ymd }); 
                return data.mealServiceDietInfo ? data.mealServiceDietInfo[1].row[0] : null; 
            } catch (e) { return null; }
        }

        function toggleView(mode) { 
            config.viewMode = mode; 
            if (mode === 'album') startAlbum(); else stopAlbum();
            renderContent(); 
            saveToLocal(); 
        }

        async function renderContent() {
            const container = document.getElementById('content-display-area');
            const titleEl = document.getElementById('right-title');
            const subtitleEl = document.getElementById('right-subtitle');
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            
            ['rules', 'notice', 'announcements', 'meal', 'album'].forEach(m => {
                const btn = document.getElementById(`btn-view-${m}`);
                if(btn) btn.className = (config.viewMode === m) ? "px-5 py-2.5 rounded-lg font-black transition-all text-sm bg-orange-500 text-white shadow-lg" : "px-5 py-2.5 rounded-lg font-bold transition-all text-sm text-slate-500 hover:bg-white/60";
            });

            if (config.viewMode === 'album') {
                titleEl.innerText = "ìš°ë¦¬ ë°˜ ì•¨ë²”"; subtitleEl.innerText = "Smart Dashboard";
                if (albumPhotos.length === 0) {
                    container.innerHTML = `<div class="glass p-10 rounded-[3rem] h-full flex flex-col items-center justify-center opacity-50"><i data-lucide="images" class="w-20 h-20 mb-4"></i><p class="text-xl font-bold">í™˜ê²½ ì„¤ì •ì—ì„œ ì‚¬ì§„ í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</p></div>`;
                } else {
                    container.innerHTML = `<div class="w-full h-full flex items-center justify-center overflow-hidden"><img id="album-image" src="${albumPhotos[albumIdx]}" class="max-w-full max-h-full object-contain"></div>`;
                }
            } else if (config.viewMode === 'meal') {
                titleEl.innerText = "ì˜¤ëŠ˜ì˜ ê¸‰ì‹"; subtitleEl.innerText = "Smart Dashboard";
                container.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
                const data = await getMealData();
                const formattedDate = `${mealDate.getFullYear()}.${String(mealDate.getMonth()+1).padStart(2,'0')}.${String(mealDate.getDate()).padStart(2,'0')} (${dayNames[mealDate.getDay()]})`;
                let mealHtml = `<div class="glass p-8 rounded-[3rem] shadow-xl h-full flex flex-col border-white/50 animate-in fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="changeMealDate(-1)" class="p-2 hover:bg-orange-100 rounded-full"><i data-lucide="chevron-left"></i></button>
                        <span class="text-2xl font-black text-slate-700">${formattedDate}</span>
                        <button onclick="changeMealDate(1)" class="p-2 hover:bg-orange-100 rounded-full"><i data-lucide="chevron-right"></i></button>
                    </div>`;
                if (data) {
                    const menus = data.DDISH_NM.split('<br/>').map(m => m.replace(/\([0-9.]+\)/g, '').trim());
                    mealHtml += `<div class="flex-1 grid grid-cols-2 gap-4">
                        ${menus.map(m => `<div class="p-4 bg-white/40 rounded-2xl font-bold text-xl text-slate-700">${m}</div>`).join('')}
                    </div><div class="mt-4 text-right text-orange-500 font-bold">${data.CAL_INFO}</div>`;
                } else {
                    mealHtml += `<div class="flex-1 flex items-center justify-center opacity-40"><p class="text-xl font-bold">ì‹ë‹¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>`;
                }
                mealHtml += `</div>`; container.innerHTML = mealHtml;
            } else if (config.viewMode === 'notice') {
                titleEl.innerText = "ì•Œë¦¼ì¥"; subtitleEl.innerText = "Smart Dashboard";
                const ymdKey = noticeDate.toISOString().split('T')[0];
                const formattedDate = `${noticeDate.getFullYear()}.${String(noticeDate.getMonth()+1).padStart(2,'0')}.${String(noticeDate.getDate()).padStart(2,'0')} (${dayNames[noticeDate.getDay()]})`;
                container.innerHTML = `<div class="glass p-8 rounded-[3rem] shadow-xl h-full flex flex-col border-white/50 animate-in fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="changeNoticeDate(-1)" class="p-2 hover:bg-orange-100 rounded-full"><i data-lucide="chevron-left"></i></button>
                        <span class="text-2xl font-black text-slate-700">${formattedDate}</span>
                        <button onclick="changeNoticeDate(1)" class="p-2 hover:bg-orange-100 rounded-full"><i data-lucide="chevron-right"></i></button>
                    </div><textarea id="notice-textarea" oninput="saveNoticeForDate(this.value)" placeholder="ì•Œë¦¼ì¥ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">${config.notices[ymdKey] || ''}</textarea></div>`;
            } else {
                const type = config.viewMode === 'rules' ? 'rules' : 'announcements';
                titleEl.innerText = type === 'rules' ? "ìš°ë¦¬ ë°˜ ì•½ì†" : "ê³µì§€ì‚¬í•­"; 
                subtitleEl.innerText = "Smart Dashboard";
                let html = `<div class="space-y-4">`;
                config[type].forEach((item, idx) => {
                    html += `<div class="glass p-6 rounded-[2rem] flex items-center gap-6 group">
                        <span class="text-4xl font-black opacity-10">${String(idx + 1).padStart(2, '0')}</span>
                        <div class="flex-1">
                            <input type="text" value="${item.title}" oninput="config['${type}'][${idx}].title = this.value; saveToLocal();" class="editable-input text-2xl font-black text-slate-800" placeholder="ì œëª©">
                            <input type="text" value="${item.desc}" oninput="config['${type}'][${idx}].desc = this.value; saveToLocal();" class="editable-input text-lg text-slate-500 font-bold" placeholder="ë‚´ìš©">
                        </div>
                        <button onclick="config['${type}'].splice(${idx}, 1); renderContent(); saveToLocal();" class="p-2 text-red-400 opacity-0 group-hover:opacity-100"><i data-lucide="trash-2"></i></button>
                    </div>`;
                });
                html += `<button onclick="config['${type}'].push({title:'', desc:''}); renderContent(); saveToLocal();" class="w-full py-5 border-4 border-dashed border-white/40 rounded-[2rem] text-white/60 font-black hover:bg-white/20">+ ì¶”ê°€í•˜ê¸°</button></div>`;
                container.innerHTML = html;
            }
            lucide.createIcons();
        }

        function changeMealDate(days) { mealDate.setDate(mealDate.getDate() + days); renderContent(); }
        function changeNoticeDate(days) { noticeDate.setDate(noticeDate.getDate() + days); renderContent(); }
        function saveNoticeForDate(val) { const ymd = noticeDate.toISOString().split('T')[0]; config.notices[ymd] = val; saveToLocal(); showAutoSaveIndicator(); }

        /* ì„¤ì • */
        async function searchSchoolInSettings() {
            const r = document.getElementById('region-select').value; 
            const n = document.getElementById('school-name-search').value.trim(); 
            if(!n) return;
            const res = document.getElementById('school-search-results'); res.innerHTML='<div class="text-sm p-3">ê²€ìƒ‰ ì¤‘...</div>';
            try { 
                const d = await fetchNEIS('schoolInfo', { ATPT_OFCDC_SC_CODE:r, SCHUL_NM:n });
                if(d.schoolInfo) res.innerHTML = d.schoolInfo[1].row.map(s => `<button onclick="selectSchool('${s.ATPT_OFCDC_SC_CODE}', '${s.SD_SCHUL_CODE}', '${s.SCHUL_NM}')" class="w-full text-left p-3 border rounded-xl hover:bg-blue-50 text-sm font-bold">${s.SCHUL_NM}</button>`).join('');
                else res.innerHTML = '<div class="text-sm p-3">ê²°ê³¼ ì—†ìŒ</div>';
            } catch(e){ res.innerHTML = '<div class="text-sm p-3 text-red-500">ì˜¤ë¥˜ ë°œìƒ</div>'; }
        }
        function selectSchool(atpt, schul, name) { config.tempSchool = { atptCode:atpt, schulCode:schul, schulNm:name }; document.getElementById('selected-school-info').innerText=`âœ… ì„ íƒë¨: ${name}`; }

        function generateDefaultSchedule(startTime, lunchAfter = 4) {
            const [h, m] = startTime.split(':').map(Number); let current = h * 60 + m;
            const format = (min) => `${String(Math.floor(min/60)).padStart(2,'0')}:${String(min%60).padStart(2,'0')}`;
            let sch = [{ name: 'ì•„ì¹¨ììŠµ', start: '08:30', end: format(current) }];
            for(let i=1; i<=6; i++) {
                sch.push({ name: `${i}êµì‹œ`, start: format(current), end: format(current+40) }); current += 40;
                if (i == lunchAfter) { sch.push({ name: 'ì ì‹¬ ì‹œê°„', start: format(current), end: format(current+50) }); current += 50; } 
                else if (i < 6) { sch.push({ name: 'ì‰¬ëŠ” ì‹œê°„', start: format(current), end: format(current+10) }); current += 10; }
            }
            return sch;
        }

        function renderScheduleEditor(schArray) {
            const ed = document.getElementById('schedule-editor');
            if(!ed) return;
            ed.innerHTML = schArray.map(s => `<div class="flex flex-col gap-2 border p-4 rounded-xl bg-white schedule-item-row"><span class="font-bold text-sm text-slate-400 uppercase sch-name">${s.name}</span><div class="flex items-center gap-2"><input type="text" value="${s.start}" class="sch-start-in w-full p-2 border rounded-lg text-lg font-black text-center"><span>~</span><input type="text" value="${s.end}" class="sch-end-in w-full p-2 border rounded-lg text-lg font-black text-center"></div></div>`).join('');
        }

        function autoCalculateSchedule(st, la) { renderScheduleEditor(generateDefaultSchedule(st || "09:00", parseInt(la))); }

        function openSettings() {
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('lunch-after-input').value = config.lunchAfter || 4; 
            const de = document.getElementById('dday-editor'); de.innerHTML = '';
            config.ddays.forEach(d => addRow('dday-editor', d.text, d.date)); 
            const f = config.schedule.find(s => s.name === '1êµì‹œ'); 
            if (f) document.getElementById('start-time-trigger').value = f.start;
            document.getElementById('selected-school-info').innerText = config.schoolInfo ? `âœ… í˜„ì¬: ${config.schoolInfo.schulNm}` : "";
            renderPeriodSelectors();
            renderScheduleEditor(config.schedule); 
            lucide.createIcons();
        }

        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        function handleOutsideClick(e) { if (e.target.id === 'settings-modal') closeSettings(); }

        function saveSettings() {
            config.lunchAfter = parseInt(document.getElementById('lunch-after-input').value); 
            if(config.tempSchool) { config.schoolInfo = config.tempSchool; delete config.tempSchool; }
            const dt = document.querySelectorAll('.dday-title-in'); const dd = document.querySelectorAll('.dday-date-in'); config.ddays = [];
            dt.forEach((t, i) => { if (t.value.trim() && dd[i].value) config.ddays.push({ text: t.value, date: dd[i].value }); });
            config.dailyPeriods = { 1: parseInt(document.getElementById('period-mon').value), 2: parseInt(document.getElementById('period-tue').value), 3: parseInt(document.getElementById('period-wed').value), 4: parseInt(document.getElementById('period-thu').value), 5: parseInt(document.getElementById('period-fri').value) };
            const sRows = document.querySelectorAll('.schedule-item-row'); config.schedule = [];
            sRows.forEach(r => { config.schedule.push({ name: r.querySelector('.sch-name').innerText, start: r.querySelector('.sch-start-in').value, end: r.querySelector('.sch-end-in').value }); });
            saveToLocal(); applyBackground(); renderContent(); updateTime(); closeSettings(); showAutoSaveIndicator();
        }

        function saveToLocal() { localStorage.setItem('happy_class_config_v3_11', JSON.stringify(config)); }
        function applyBackground() { const bg = document.getElementById('bg-container'); if (config.background.type === 'default') { bg.className = "bg-default"; bg.style.backgroundImage = ""; } else { bg.className = ""; bg.style.backgroundImage = `url(${config.background.value})`; } }
        function showAutoSaveIndicator() { const i = document.getElementById('auto-save-indicator'); if(i) { i.style.opacity = '1'; setTimeout(() => { i.style.opacity = '0'; }, 1000); } }

        function renderPeriodSelectors() {
            ['mon', 'tue', 'wed', 'thu', 'fri'].forEach((day, idx) => {
                const select = document.getElementById(`period-${day}`);
                if (!select) return;
                let options = '';
                for (let i = 4; i <= 6; i++) {
                    const selected = config.dailyPeriods[idx + 1] == i ? 'selected' : '';
                    options += `<option value="${i}" ${selected}>${i}</option>`;
                }
                select.innerHTML = options;
            });
        }

        function addRow(id, t="", d="") {
            const e = document.getElementById(id); const r = document.createElement('div'); r.className = "flex gap-3 items-center dday-row";
            r.innerHTML = `<input type="text" value="${t}" class="dday-title-in flex-1 p-3 border rounded-xl text-base font-bold" placeholder="ì¼ì • ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"><input type="date" value="${d}" class="dday-date-in p-3 border rounded-xl text-base font-bold"><button onclick="this.parentElement.remove()" class="p-3 text-red-400 hover:bg-red-50 rounded-xl transition-colors"><i data-lucide="trash-2" class="w-6 h-6"></i></button>`;
            e.appendChild(r); lucide.createIcons();
        }

        window.onload = init;
    </script>
</body>
</html>

