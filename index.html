<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Class (V3.44)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts (Pretendard & Pretty Fonts) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&family=Black+Han+Sans&family=Dongle:wght@400;700&family=Gowun+Batang:wght@400;700&family=Jua&family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent-color: #6366f1;
        }
        body {
            font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            overflow: hidden;
            transition: background 0.5s ease, color 0.5s ease;
        }
        .glass {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .glass-dark {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .text-shadow-lg { text-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.1); }
        .text-shadow-strong { text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        
        #bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-size: cover; background-position: center;
            transition: all 0.8s ease;
        }
        .left-content-shadow { background: linear-gradient(to right, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        
        .editable-input { background: transparent; border: none; outline: none; width: 100%; padding: 2px 0; }
        .editable-input:focus { background: rgba(255,255,255,0.3); border-radius: 4px; }
        
        #notice-textarea { 
            background: transparent; border: none; outline: none; resize: none; 
            width: 100%; height: 100%; font-size: 2.2rem; line-height: 1.6; 
            font-weight: 800; 
        }

        #album-image {
            transition: opacity 1s ease-in-out;
            opacity: 1;
        }
        .fade-out { opacity: 0 !important; }

        .loader { 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid var(--accent-color); 
            border-radius: 50%; 
            width: 30px; height: 30px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .dynamic-accent-text { color: var(--accent-color) !important; }
        .dynamic-accent-bg { background-color: var(--accent-color) !important; }
        
        .btn-active { color: var(--accent-color) !important; background: rgba(255, 255, 255, 0.4); border-radius: 50%; }
        
        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px; height: 12px;
            background: var(--accent-color);
            cursor: pointer; border-radius: 50%;
        }

        .color-circle {
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            border: 3px solid white; transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
        }
        .color-circle:hover { transform: translateY(-2px) scale(1.1); }
        .color-circle.selected { border-color: var(--accent-color); transform: scale(1.1); }

        .custom-checkbox {
            width: 18px; height: 18px; cursor: pointer;
            accent-color: var(--accent-color);
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex items-center justify-center p-6">
    <div id="bg-container"></div>

    <main class="w-full h-full flex gap-4 z-10">
        <!-- ì¢Œì¸¡ ì˜ì—­ -->
        <section id="left-panel" class="w-[38%] flex flex-col justify-between py-12 pl-6 pr-4 left-content-shadow text-shadow-lg">
            <div class="space-y-6">
                <!-- íƒ€ì´í‹€ -->
                <h1 id="left-panel-title" class="font-black tracking-tighter text-shadow-strong">Happy Class</h1>
                
                <div class="space-y-1">
                    <div id="date-display" class="text-3xl font-bold tracking-tight opacity-90 text-nowrap">2026. 02. 28</div>
                    <div id="day-display" class="text-5xl font-black opacity-80">í† ìš”ì¼</div>
                </div>
            </div>

            <div class="flex flex-col gap-0 mt-8">
                <div class="flex flex-col items-start">
                    <span id="ampm-display" class="text-4xl font-bold mb-2 dynamic-accent-text">ì˜¤ì „</span>
                    <div class="flex items-baseline">
                        <span id="time-display" class="text-[10rem] font-black leading-none tracking-tighter text-shadow-strong">07:35</span>
                        <span class="text-4xl font-bold opacity-50 ml-4">: <span id="sec-display">28</span></span>
                    </div>
                </div>
            </div>

            <div class="space-y-3 flex flex-col items-start">
                <div id="status-badge" class="glass inline-block px-8 py-4 rounded-3xl text-3xl font-black shadow-xl border-white/50 mb-2">ì•„ì¹¨ììŠµ</div>
                <div id="dday-container" class="flex flex-wrap gap-2 max-w-full"></div>
            </div>
        </section>

        <!-- ìš°ì¸¡ ì˜ì—­ -->
        <section id="right-panel" class="w-[62%] flex flex-col p-4">
            <div class="flex justify-between items-end mb-8">
                <div class="flex items-end gap-4 overflow-x-auto custom-scrollbar pb-1">
                    <div>
                        <h2 id="right-title" class="text-5xl font-black dynamic-accent-text mb-1 text-shadow-lg text-nowrap">Dashboard</h2>
                        <p id="right-subtitle" class="text-lg font-bold tracking-widest opacity-70 uppercase">Smart Classroom</p>
                    </div>
                    <!-- íƒ­ ì „í™˜ ë²„íŠ¼ -->
                    <div class="flex bg-white/20 p-1 rounded-xl backdrop-blur-sm border border-white/20 mb-1 flex-nowrap">
                        <button onclick="toggleView('rules')" id="btn-view-rules" class="px-4 py-2.5 rounded-lg font-bold transition-all text-sm text-nowrap">ì•½ì†</button>
                        <button onclick="toggleView('notice')" id="btn-view-notice" class="px-4 py-2.5 rounded-lg font-bold transition-all text-sm text-nowrap">ì•Œë¦¼ì¥</button>
                        <button onclick="toggleView('announcements')" id="btn-view-announcements" class="px-4 py-2.5 rounded-lg font-bold transition-all text-sm text-nowrap">ê³µì§€ì‚¬í•­</button>
                        <button onclick="toggleView('meal')" id="btn-view-meal" class="px-4 py-2.5 rounded-lg font-bold transition-all text-sm text-nowrap">ê¸‰ì‹</button>
                        <button onclick="toggleView('album')" id="btn-view-album" class="px-4 py-2.5 rounded-lg font-bold transition-all text-sm text-nowrap">ì•¨ë²”</button>
                    </div>
                </div>
                
                <!-- ìš°ì¸¡ ìƒë‹¨ ê¸°ëŠ¥ ë²„íŠ¼ -->
                <div class="flex items-end gap-3 pb-1">
                    <div id="auto-save-indicator" class="flex items-center gap-2 px-2 py-2.5 text-slate-400 font-bold transition-all opacity-0">
                        <i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>
                    </div>

                    <div class="flex items-center gap-1 bg-white/30 backdrop-blur-md rounded-full px-3 py-1 shadow-lg border border-white/20">
                        <button onclick="playPrev()" class="p-1.5 hover:scale-110 transition-all opacity-70 hover:opacity-100">
                            <i data-lucide="skip-back" class="w-5 h-5"></i>
                        </button>
                        <button id="music-play-btn" onclick="toggleMusic()" class="p-2 hover:scale-110 transition-all dynamic-accent-text">
                            <i data-lucide="play" id="music-icon" class="w-7 h-7"></i>
                        </button>
                        <button onclick="playNext()" class="p-1.5 hover:scale-110 transition-all opacity-70 hover:opacity-100">
                            <i data-lucide="skip-forward" class="w-5 h-5"></i>
                        </button>
                        <button id="music-shuffle-btn" onclick="toggleShuffle()" class="p-1.5 hover:scale-110 transition-all ml-1 opacity-40">
                            <i data-lucide="shuffle" class="w-5 h-5"></i>
                        </button>
                        <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.5" class="w-10 h-1 bg-white/40 rounded-lg appearance-none cursor-pointer mx-2" oninput="setVolume(this.value)">
                    </div>

                    <button onclick="openSettings()" class="p-3 bg-white/30 backdrop-blur-md rounded-full hover:bg-white/50 transition-all shadow-lg border border-white/20">
                        <i data-lucide="settings" class="w-8 h-8"></i>
                    </button>
                </div>
            </div>

            <div id="content-display-area" class="flex-1 overflow-y-auto pr-2 custom-scrollbar"></div>
            <div class="h-8"></div>
        </section>
    </main>

    <!-- í™˜ê²½ ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 hidden items-start justify-center z-50 p-4 backdrop-blur-sm overflow-y-auto" onclick="handleOutsideClick(event)">
        <div class="bg-white rounded-[2.5rem] w-full max-w-4xl my-8 p-10 shadow-2xl relative" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div class="flex items-center gap-3">
                    <i data-lucide="sliders" class="text-orange-500 w-8 h-8"></i>
                    <h3 class="text-3xl font-black text-slate-800 text-nowrap">í™˜ê²½ ì„¤ì •</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="saveSettings()" class="px-6 py-2 bg-orange-500 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-orange-600 transition-all">ì„¤ì • ì €ì¥ ë° ì ìš©</button>
                    <button onclick="closeSettings()" class="p-2 hover:bg-slate-100 rounded-full text-slate-400 transition-colors"><i data-lucide="x" class="w-8 h-8"></i></button>
                </div>
            </div>

            <div class="space-y-8 pb-4">
                <!-- ì œëª© ì„¸ë¶€ ì„¤ì • -->
                <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100 space-y-4">
                    <h4 class="font-bold text-xl flex items-center gap-2 text-indigo-700"><i data-lucide="type" class="w-6 h-6"></i> ì•± ì œëª© ì„¸ë¶€ ì„¤ì •</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="flex flex-col gap-1">
                            <label class="text-xs font-bold text-indigo-400 ml-1">ì œëª© ë‚´ìš©</label>
                            <input type="text" id="title-text-input" class="p-2 border rounded-xl font-bold bg-white text-slate-700 outline-none focus:ring-2 focus:ring-indigo-300">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs font-bold text-indigo-400 ml-1">ê¸€ê¼´ ì„ íƒ</label>
                            <select id="title-font-input" class="p-2 border rounded-xl font-bold bg-white text-slate-700 outline-none focus:ring-2 focus:ring-indigo-300">
                                <optgroup label="ê¸°ë³¸ ê¸€ê¼´">
                                    <option value='"Pretendard Variable", Pretendard'>Pretendard (ê¸°ë³¸)</option>
                                    <option value='"Malgun Gothic", sans-serif'>ë§‘ì€ ê³ ë”•</option>
                                </optgroup>
                                <optgroup label="ì˜ˆìœ ê¸€ê¼´ (ì¶”ì²œ)">
                                    <option value="'Bagel Fat One', cursive">ë² ì´ê¸€íŒ»ì› (ê·€ì—¼)</option>
                                    <option value="'Black Han Sans', sans-serif">ê²€ì€ê³ ë”• (ì„íŒ©íŠ¸)</option>
                                    <option value="'Jua', sans-serif">ì£¼ì•„ì²´ (ë¶€ë“œëŸ¬ì›€)</option>
                                    <option value="'Dongle', sans-serif">ë™ê¸€ì²´ (ì†ê¸€ì”¨)</option>
                                    <option value="'Gowun Batang', serif">ê³ ìš´ë°”íƒ• (ê²©ì‹)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs font-bold text-indigo-400 ml-1">ê¸€ì í¬ê¸°</label>
                            <select id="title-size-input" class="p-2 border rounded-xl font-bold bg-white text-slate-700 outline-none focus:ring-2 focus:ring-indigo-300">
                                <option value="4xl">4xl</option><option value="5xl">5xl</option>
                                <option value="6xl">6xl</option><option value="7xl">7xl</option>
                                <option value="8xl">8xl</option><option value="9xl">9xl</option>
                            </select>
                        </div>
                        <!-- ê¸€ì ìƒ‰ìƒ ë° í…Œë§ˆ ë§ì¶¤ í•œ ì¤„ ë°°ì¹˜ ìˆ˜ì • ì˜ì—­ -->
                        <div class="flex flex-col gap-1">
                            <label class="text-xs font-bold text-indigo-400 ml-1">ê¸€ì ìƒ‰ìƒ</label>
                            <div class="flex items-center gap-2 bg-white p-1 rounded-xl border border-indigo-100 h-[42px]">
                                <input type="color" id="title-color-input" class="w-12 h-8 border-none bg-transparent cursor-pointer disabled:opacity-30 transition-opacity">
                                <div class="h-4 w-px bg-slate-200"></div>
                                <div class="flex items-center gap-1.5 pr-2">
                                    <input type="checkbox" id="title-sync-checkbox" class="custom-checkbox scale-90" onchange="toggleTitleColorPicker(this.checked)">
                                    <label for="title-sync-checkbox" class="text-[11px] font-bold text-slate-500 cursor-pointer whitespace-nowrap">í…Œë§ˆìƒ‰ ë§ì¶¤</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 text-slate-800">
                    <div class="lg:col-span-2 space-y-3 bg-orange-50 p-5 rounded-2xl border border-orange-100">
                        <h4 class="font-bold text-lg flex items-center gap-2 text-orange-700"><i data-lucide="play-circle" class="w-5 h-5"></i> ì•¨ë²” ë° ìŒì•… ì„¤ì •</h4>
                        <div class="flex flex-col gap-2">
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('album-folder-input').click()" class="flex-1 flex items-center justify-center gap-1 p-2 bg-white border border-orange-200 text-orange-600 rounded-xl font-bold text-xs hover:bg-orange-100 transition-all">
                                    <i data-lucide="folder-open" class="w-3 h-3"></i> ì‚¬ì§„ í´ë”
                                </button>
                                <button onclick="document.getElementById('album-file-input').click()" class="flex-1 flex items-center justify-center gap-1 p-2 bg-white border border-orange-200 text-orange-600 rounded-xl font-bold text-xs hover:bg-orange-100 transition-all">
                                    <i data-lucide="image" class="w-3 h-3"></i> ì‚¬ì§„ íŒŒì¼
                                </button>
                            </div>
                            <div class="flex items-center gap-2 bg-white/50 p-2 rounded-xl border border-orange-100">
                                <span class="text-xs font-bold text-orange-600 whitespace-nowrap">ìŠ¬ë¼ì´ë“œ ê°„ê²©(ì´ˆ):</span>
                                <input type="number" id="album-interval-input" min="1" max="60" step="1" class="flex-1 p-1 text-center font-bold border rounded-lg outline-none focus:ring-1 focus:ring-orange-400 text-slate-700">
                            </div>
                            
                            <input type="file" id="album-folder-input" webkitdirectory directory multiple class="hidden" onchange="handleAlbumFiles(this)">
                            <input type="file" id="album-file-input" accept="image/*" multiple class="hidden" onchange="handleAlbumFiles(this)">
                            
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('music-folder-input').click()" class="flex-1 flex items-center justify-center gap-1 p-2 bg-white border border-orange-200 text-orange-600 rounded-xl font-bold text-xs hover:bg-orange-100 transition-all">
                                    <i data-lucide="folder-open" class="w-3 h-3"></i> ìŒì•… í´ë”
                                </button>
                                <button onclick="document.getElementById('music-file-input').click()" class="flex-1 flex items-center justify-center gap-1 p-2 bg-white border border-orange-200 text-orange-600 rounded-xl font-bold text-xs hover:bg-orange-100 transition-all">
                                    <i data-lucide="music" class="w-3 h-3"></i> ìŒì•… íŒŒì¼
                                </button>
                            </div>
                            <input type="file" id="music-folder-input" webkitdirectory directory multiple class="hidden" onchange="loadMusic(this)">
                            <input type="file" id="music-file-input" accept="audio/*" multiple class="hidden" onchange="loadMusic(this)">
                            <p id="album-status-msg" class="text-[10px] text-slate-400 font-bold text-center">ì„ íƒëœ ë¯¸ë””ì–´ ì •ë³´ ì—†ìŒ</p>
                        </div>
                    </div>

                    <div class="lg:col-span-3 space-y-3 bg-slate-50 p-5 rounded-2xl border border-slate-200">
                        <h4 class="font-bold text-lg flex items-center gap-2 text-slate-700"><i data-lucide="palette" class="w-5 h-5"></i> ë°°ê²½ í…Œë§ˆ ìƒ‰ìƒ</h4>
                        <div class="grid grid-cols-6 gap-3 items-center justify-items-center py-2">
                            <div onclick="setThemeColor('default')" id="color-default" class="color-circle bg-[#FDFCFB]" title="ê·¸ë¼ë””ì–¸íŠ¸"></div>
                            <div onclick="setThemeColor('pastel-blue')" id="color-pastel-blue" class="color-circle bg-[#E0F2FE]" title="íŒŒìŠ¤í…” ë¸”ë£¨"></div>
                            <div onclick="setThemeColor('pastel-indigo')" id="color-pastel-indigo" class="color-circle bg-[#E0E7FF]" title="ë¼ë²¤ë” ë¸”ë£¨"></div>
                            <div onclick="setThemeColor('pastel-green')" id="color-pastel-green" class="color-circle bg-[#DCFCE7]" title="íŒŒìŠ¤í…” ê·¸ë¦°"></div>
                            <div onclick="setThemeColor('pastel-emerald')" id="color-pastel-emerald" class="color-circle bg-[#D1FAE5]" title="ë¯¼íŠ¸ ê·¸ë¦°"></div>
                            <div onclick="setThemeColor('pastel-teal')" id="color-pastel-teal" class="color-circle bg-[#CCFBF1]" title="ì†Œí”„íŠ¸ í‹°ì•Œ"></div>
                            <div onclick="setThemeColor('pastel-pink')" id="color-pastel-pink" class="color-circle bg-[#FCE7F3]" title="íŒŒìŠ¤í…” í•‘í¬"></div>
                            <div onclick="setThemeColor('pastel-rose')" id="color-pastel-rose" class="color-circle bg-[#FFE4E6]" title="íŒŒìŠ¤í…” ë¡œì¦ˆ"></div>
                            <div onclick="setThemeColor('pastel-orange')" id="color-pastel-orange" class="color-circle bg-[#FFEDD5]" title="íŒŒìŠ¤í…” í”¼ì¹˜"></div>
                            <div onclick="setThemeColor('pastel-yellow')" id="color-pastel-yellow" class="color-circle bg-[#FEF9C3]" title="íŒŒìŠ¤í…” ì˜ë¡œìš°"></div>
                            <div onclick="setThemeColor('pastel-purple')" id="color-pastel-purple" class="color-circle bg-[#F3E8FF]" title="íŒŒìŠ¤í…” í¼í”Œ"></div>
                            <div onclick="document.getElementById('custom-color-input').click()" id="color-custom" class="color-circle bg-white text-slate-400" title="ìƒ‰ìƒ ì§ì ‘ ì„ íƒ">
                                <i data-lucide="plus" class="w-6 h-6"></i>
                            </div>
                            <input type="color" id="custom-color-input" class="hidden" oninput="handleCustomColor(this.value)">
                        </div>
                    </div>
                </div>

                <div class="space-y-3 bg-blue-50 p-5 rounded-2xl border border-blue-100">
                    <h4 class="font-bold text-lg flex items-center gap-2 text-blue-700"><i data-lucide="utensils" class="w-5 h-5"></i> ìš°ë¦¬ í•™êµ ê¸‰ì‹ ì„¤ì •</h4>
                    <div class="flex gap-3 text-slate-800">
                        <select id="region-select" class="p-3 border rounded-xl font-bold text-base focus:ring-2 focus:ring-blue-400 outline-none w-32 bg-white">
                            <option value="B10">ì„œìš¸</option><option value="C10">ë¶€ì‚°</option><option value="D10">ëŒ€êµ¬</option>
                            <option value="E10">ì¸ì²œ</option><option value="F10">ê´‘ì£¼</option><option value="G10">ëŒ€ì „</option>
                            <option value="H10">ìš¸ì‚°</option><option value="I10">ì„¸ì¢…</option><option value="J10" selected>ê²½ê¸°</option>
                            <option value="K10">ê°•ì›</option><option value="M10">ì¶©ë¶</option><option value="N10">ì¶©ë‚¨</option>
                            <option value="P10">ì „ë¶</option><option value="Q10">ì „ë‚¨</option><option value="R10">ê²½ë¶</option>
                            <option value="S10">ê²½ë‚¨</option><option value="T10">ì œì£¼</option>
                        </select>
                        <div class="relative flex-1">
                            <input type="text" id="school-name-search" placeholder="í•™êµ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 border rounded-xl font-bold text-base focus:ring-2 focus:ring-blue-400 outline-none bg-white text-slate-800">
                            <button onclick="searchSchoolInSettings()" class="absolute right-2 top-2 bg-blue-600 text-white px-4 py-1.5 rounded-lg font-bold text-sm">ê²€ìƒ‰</button>
                        </div>
                    </div>
                    <div id="school-search-results" class="space-y-2 mt-2 max-h-40 overflow-y-auto custom-scrollbar"></div>
                    <div id="selected-school-info" class="text-sm font-bold text-blue-600 mt-1"></div>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-xl flex items-center gap-2 text-slate-700"><i data-lucide="calendar-check" class="w-6 h-6"></i> D-Day ê´€ë¦¬</h4>
                        <button onclick="addRow('dday-editor')" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-xl text-sm font-bold border border-blue-100">+ ì¶”ê°€</button>
                    </div>
                    <div id="dday-editor" class="space-y-3"></div>
                </div>

                <div class="space-y-4 bg-slate-50 p-5 rounded-2xl border border-slate-200">
                    <h4 class="font-bold text-xl flex items-center gap-2 text-slate-700"><i data-lucide="layout-list" class="w-6 h-6"></i> ìš”ì¼ë³„ ìˆ˜ì—… ì‹œìˆ˜</h4>
                    <div class="grid grid-cols-5 gap-4">
                        <div class="text-center space-y-1"><span class="text-sm font-bold text-slate-400">ì›”ìš”ì¼</span><select id="period-mon" class="w-full p-2 border rounded-xl text-lg font-black text-center bg-white text-slate-800"></select></div>
                        <div class="text-center space-y-1"><span class="text-sm font-bold text-slate-400">í™”ìš”ì¼</span><select id="period-tue" class="w-full p-2 border rounded-xl text-lg font-black text-center bg-white text-slate-800"></select></div>
                        <div class="text-center space-y-1"><span class="text-sm font-bold text-slate-400">ìˆ˜ìš”ì¼</span><select id="period-wed" class="w-full p-2 border rounded-xl text-lg font-black text-center dynamic-accent-text bg-white"></select></div>
                        <div class="text-center space-y-1"><span class="text-sm font-bold text-slate-400">ëª©ìš”ì¼</span><select id="period-thu" class="w-full p-2 border rounded-xl text-lg font-black text-center bg-white text-slate-800"></select></div>
                        <div class="text-center space-y-1"><span class="text-sm font-bold text-slate-400">ê¸ˆìš”ì¼</span><select id="period-fri" class="w-full p-2 border rounded-xl text-lg font-black text-center bg-white text-slate-800"></select></div>
                    </div>
                </div>

                <div class="space-y-4 bg-slate-50 p-5 rounded-2xl border border-slate-200">
                    <h4 class="font-bold text-xl flex items-center gap-2 text-slate-700"><i data-lucide="clock" class="w-6 h-6"></i> ì‹œì •í‘œ ì„¤ì • ê¸°ì¤€</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-bold text-slate-500 ml-1">1êµì‹œ ì‹œì‘ ì‹œê°„</label>
                            <input type="time" id="start-time-trigger" class="w-full p-3 border rounded-xl text-xl font-black outline-none focus:ring-2 focus:ring-orange-400 bg-white text-slate-800" onchange="autoCalculateSchedule(this.value, document.getElementById('lunch-after-input').value)">
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-bold text-slate-500 ml-1">ì ì‹¬ì‹œê°„ ìœ„ì¹˜</label>
                            <select id="lunch-after-input" class="w-full p-3 border rounded-xl text-xl font-black outline-none focus:ring-2 focus:ring-blue-400 bg-white text-slate-800" onchange="autoCalculateSchedule(document.getElementById('start-time-trigger').value, this.value)">
                                <option value="1">1êµì‹œ í›„ ì ì‹¬</option><option value="2">2êµì‹œ í›„ ì ì‹¬</option>
                                <option value="3">3êµì‹œ í›„ ì ì‹¬</option><option value="4" selected>4êµì‹œ í›„ ì ì‹¬</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="font-bold text-xl text-slate-700 ml-1">ì‹œì •í‘œ ë‚´ìš© í™•ì¸ ë° ìˆ˜ì •</h4>
                    <div id="schedule-editor" class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-slate-800"></div>
                </div>

                <div class="mt-8 border-t pt-8 text-center">
                    <button onclick="saveSettings()" class="w-full py-5 bg-orange-500 text-white rounded-2xl font-black text-2xl shadow-xl hover:bg-orange-600 active:scale-[0.98] transition-all">ì„¤ì • ì €ì¥ ë° ì ìš©</button>
                    <p class="mt-4 opacity-20 text-xs">Happy Class V3.44 Dashboard</p>
                </div>
            </div>
        </div>
    </div>

    <audio id="bgm-audio"></audio>
    <audio id="chime-audio" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const NEIS_API_KEY = ""; 
        const NEIS_BASE_URL = "https://open.neis.go.kr/hub";

        let config = {
            viewMode: 'rules',
            notices: {},
            themeColor: 'pastel-indigo', 
            customColor: '#ffffff',
            lunchAfter: 4,
            schoolInfo: null,
            isShuffle: false,
            albumIntervalSeconds: 5,
            titleConfig: {
                text: 'Happy Class',
                font: '"Pretendard Variable", Pretendard',
                size: '6xl',
                color: '#6366f1',
                syncWithTheme: true
            },
            ddays: [{ text: 'ì—¬ë¦„ë°©í•™', date: '2026-07-31' }],
            rules: [{ title: 'ì„œë¡œ ì¡´ì¤‘í•˜ê¸°', desc: 'ì¹œêµ¬ì˜ ë§ì— ê·€ ê¸°ìš¸ì´ê³ , ë‹¤ë¦„ì„ ì¸ì •í•´ìš”' }, { title: 'ìˆ˜ì—…ì— ì§‘ì¤‘í•˜ê¸°', desc: 'ê²½ì²­í•˜ê³  ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•´ìš”' }],
            announcements: [{ title: 'ì˜¤ëŠ˜ì˜ ë‚ ì”¨', desc: 'ë¯¸ì„¸ë¨¼ì§€ í™•ì¸ í›„ ë§ˆìŠ¤í¬ë¥¼ ì°©ìš©í•˜ì„¸ìš”' }],
            dailyPeriods: { 1: 6, 2: 6, 3: 5, 4: 6, 5: 6 },
            schedule: []
        };

        const THEMES = {
            'default': 'linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%)',
            'pastel-blue': '#E0F2FE',
            'pastel-indigo': '#E0E7FF',
            'pastel-green': '#DCFCE7',
            'pastel-emerald': '#D1FAE5',
            'pastel-teal': '#CCFBF1',
            'pastel-pink': '#FCE7F3',
            'pastel-rose': '#FFE4E6',
            'pastel-orange': '#FFEDD5',
            'pastel-yellow': '#FEF9C3',
            'pastel-purple': '#F3E8FF',
            'custom': '' 
        };

        const ACCENTS = {
            'default': '#f97316', 'pastel-blue': '#0284c7', 'pastel-indigo': '#6366f1',
            'pastel-green': '#16a34a', 'pastel-emerald': '#059669', 'pastel-teal': '#0d9488',
            'pastel-pink': '#db2777', 'pastel-rose': '#e11d48', 'pastel-orange': '#ea580c',
            'pastel-yellow': '#ca8a04', 'pastel-purple': '#9333ea', 'custom': '#f97316'
        };

        let mealDate = new Date();
        let noticeDate = new Date();
        let albumPhotos = []; 
        let albumIdx = 0;
        let albumInterval = null;
        let musicPlaylist = [];
        let currentMusicIdx = 0;

        const saved = localStorage.getItem('happy_class_config_v3_44');
        if (saved) {
            config = { ...config, ...JSON.parse(saved) };
        } else {
            const oldSaved = localStorage.getItem('happy_class_config_v3_43');
            if (oldSaved) config = { ...config, ...JSON.parse(oldSaved) };
        }
        
        if (!config.schedule || config.schedule.length === 0) config.schedule = generateDefaultSchedule('09:00', config.lunchAfter);

        const audioChime = document.getElementById('chime-audio');
        const audioBgm = document.getElementById('bgm-audio');

        function init() {
            lucide.createIcons();
            applyBackground();
            applyTitleConfig();
            renderContent();
            renderPeriodSelectors();
            updateTime();
            setInterval(updateTime, 1000);
            
            audioBgm.onended = () => { playNext(); };
            if (config.isShuffle) {
                document.getElementById('music-shuffle-btn')?.classList.add('btn-active');
                document.getElementById('music-shuffle-btn')?.classList.replace('opacity-40', 'opacity-100');
            }
        }

        function applyTitleConfig() {
            const titleEl = document.getElementById('left-panel-title');
            if (!titleEl) return;

            const c = config.titleConfig;
            titleEl.innerText = c.text || 'Happy Class';
            titleEl.style.fontFamily = c.font || '"Pretendard Variable", Pretendard';
            
            const sizeClasses = ['text-4xl', 'text-5xl', 'text-6xl', 'text-7xl', 'text-8xl', 'text-9xl'];
            titleEl.classList.remove(...sizeClasses);
            titleEl.classList.add(`text-${c.size || '6xl'}`);

            if (c.syncWithTheme) {
                titleEl.classList.add('dynamic-accent-text');
                titleEl.style.removeProperty('color');
            } else {
                titleEl.classList.remove('dynamic-accent-text');
                titleEl.style.color = c.color || '#1e293b';
            }
        }

        function toggleTitleColorPicker(isSync) {
            const picker = document.getElementById('title-color-input');
            if (picker) picker.disabled = isSync;
        }

        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const date = String(now.getDate()).padStart(2, '0');
            const dayNames = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
            const dayIdx = now.getDay();
            
            document.getElementById('date-display').innerText = `${year}. ${month}. ${date}`;
            document.getElementById('day-display').innerText = dayNames[dayIdx];

            let h = now.getHours() % 12 || 12;
            const ampm = now.getHours() >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
            document.getElementById('ampm-display').innerText = ampm;
            document.getElementById('time-display').innerText = `${String(h).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            document.getElementById('sec-display').innerText = String(now.getSeconds()).padStart(2,'0');

            updateStatus(now, dayIdx, `${month}-${date}`);
            updateDday(now);
        }

        function updateStatus(now, dayIdx, monthDay) {
            const currentTime = now.getHours() * 60 + now.getMinutes();
            let status = "Happy Ready";
            const HOLIDAYS = ['01-01', '03-01', '05-05', '06-06', '08-15', '10-03', '10-09', '12-25'];
            
            if (dayIdx === 0 || dayIdx === 6) status = "ì£¼ë§";
            else if (HOLIDAYS.includes(monthDay)) status = "ê³µíœ´ì¼";
            else {
                const max = config.dailyPeriods[dayIdx] || 6;
                let found = false;
                for (const item of config.schedule) {
                    const match = item.name.match(/(\d)êµì‹œ/);
                    if (match && parseInt(match[1]) > max) continue;
                    const [sH, sM] = item.start.split(':').map(Number);
                    const [eH, eM] = item.end.split(':').map(Number);
                    if (currentTime >= (sH * 60 + sM) && currentTime < (eH * 60 + eM)) {
                        status = item.name; found = true; break;
                    }
                }
                if (!found && currentTime >= 480) status = "ë°©ê³¼í›„ ì‹œê°„";
            }
            const badge = document.getElementById('status-badge');
            if (badge) {
                badge.innerText = status;
                badge.className = (status === "ì£¼ë§" || status === "ê³µíœ´ì¼") 
                    ? "glass inline-block px-8 py-4 rounded-3xl text-3xl font-black shadow-xl border-white/50 text-red-500 mb-2"
                    : `glass inline-block px-8 py-4 rounded-3xl text-3xl font-black shadow-xl border-white/50 mb-2 ${status.includes('êµì‹œ') ? 'dynamic-accent-text' : 'text-blue-600'}`;
            }
        }

        function updateDday(now) {
            const container = document.getElementById('dday-container');
            if(!container) return;
            container.innerHTML = '';
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            config.ddays.forEach(item => {
                const target = new Date(item.date);
                target.setHours(0,0,0,0);
                const diff = target - today;
                const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                if (days >= 0) {
                    const el = document.createElement('div');
                    el.className = "bg-white/60 backdrop-blur-sm px-4 py-2 rounded-2xl border border-white/40 shadow-sm text-lg font-bold text-slate-700";
                    el.innerText = days === 0 ? `ì˜¤ëŠ˜: ${item.text} ğŸˆ` : `${item.text} D-${days}`;
                    container.appendChild(el);
                }
            });
        }

        function startAlbum() {
            if (albumInterval) clearInterval(albumInterval);
            if (albumPhotos.length > 1) {
                const intervalMs = (config.albumIntervalSeconds || 5) * 1000;
                albumInterval = setInterval(() => {
                    const img = document.getElementById('album-image');
                    if (img) {
                        img.classList.add('fade-out');
                        setTimeout(() => {
                            albumIdx = (albumIdx + 1) % albumPhotos.length;
                            img.src = albumPhotos[albumIdx];
                            img.classList.remove('fade-out');
                        }, 1000); 
                    }
                }, intervalMs); 
            }
        }
        function stopAlbum() { if (albumInterval) clearInterval(albumInterval); }
        
        function handleAlbumFiles(input) {
            const files = Array.from(input.files).filter(f => f.type.startsWith('image/'));
            if (files.length === 0) return;
            albumPhotos = files.map(f => URL.createObjectURL(f));
            albumIdx = 0;
            document.getElementById('album-status-msg').innerText = `${files.length}ì¥ì˜ ì‚¬ì§„ ì„ íƒë¨`;
            if (config.viewMode === 'album') renderContent();
        }

        function toggleMusic() {
            if (musicPlaylist.length === 0) { openSettings(); return; }
            if (audioBgm.paused) {
                if (!audioBgm.src && musicPlaylist.length > 0) playTrack(0);
                else audioBgm.play();
                document.getElementById('music-icon').setAttribute('data-lucide', 'pause'); 
            } else {
                audioBgm.pause(); 
                document.getElementById('music-icon').setAttribute('data-lucide', 'play');
            }
            lucide.createIcons();
        }

        function playNext() {
            if (musicPlaylist.length === 0) return;
            if (config.isShuffle) currentMusicIdx = Math.floor(Math.random() * musicPlaylist.length);
            else currentMusicIdx = (currentMusicIdx + 1) % musicPlaylist.length;
            playTrack(currentMusicIdx);
        }

        function playPrev() {
            if (musicPlaylist.length === 0) return;
            currentMusicIdx = (currentMusicIdx - 1 + musicPlaylist.length) % musicPlaylist.length;
            playTrack(currentMusicIdx);
        }

        function toggleShuffle() {
            config.isShuffle = !config.isShuffle;
            const btn = document.getElementById('music-shuffle-btn');
            if (config.isShuffle) {
                btn?.classList.add('btn-active');
                btn?.classList.replace('opacity-40', 'opacity-100');
            } else {
                btn?.classList.remove('btn-active');
                btn?.classList.replace('opacity-100', 'opacity-40');
            }
            saveToLocal();
        }

        function loadMusic(input) {
            const files = Array.from(input.files).filter(f => f.type.startsWith('audio/'));
            if (files.length === 0) return;
            musicPlaylist = files.map(f => ({ url: URL.createObjectURL(f), name: f.name }));
            currentMusicIdx = 0;
            playTrack(0);
            document.getElementById('album-status-msg').innerText = `${files.length}ê³¡ì˜ ìŒì•… ì„ íƒë¨`;
        }

        function playTrack(idx) {
            if (!musicPlaylist[idx]) return;
            audioBgm.src = musicPlaylist[idx].url;
            audioBgm.play().catch(e => console.log(e));
            document.getElementById('music-icon').setAttribute('data-lucide', 'pause');
            lucide.createIcons();
        }

        function setVolume(val) { audioBgm.volume = val; }

        function setThemeColor(themeKey) {
            config.themeColor = themeKey;
            applyBackground();
            applyTitleConfig(); 
            updateColorSelectionUI();
            renderContent();
            saveToLocal();
        }

        function handleCustomColor(hex) {
            config.themeColor = 'custom';
            config.customColor = hex;
            document.getElementById('color-custom').style.backgroundColor = hex;
            applyBackground();
            applyTitleConfig(); 
            updateColorSelectionUI();
            renderContent();
            saveToLocal();
        }

        function updateColorSelectionUI() {
            document.querySelectorAll('.color-circle').forEach(el => el.classList.remove('selected'));
            const targetId = config.themeColor === 'custom' ? 'color-custom' : `color-${config.themeColor}`;
            document.getElementById(targetId)?.classList.add('selected');
        }

        function getLuminance(hex) {
            if (!hex || hex.startsWith('linear-gradient')) return 0.9; 
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return 0.2126 * r + 0.7152 * g + 0.0722 * b;
        }

        function applyBackground() { 
            const bg = document.getElementById('bg-container');
            const themeValue = THEMES[config.themeColor] || THEMES['pastel-indigo'];
            let currentHex = themeValue;

            if (config.themeColor === 'default') { bg.style.background = THEMES['default']; } 
            else if (config.themeColor === 'custom') { bg.style.background = config.customColor; currentHex = config.customColor; } 
            else { bg.style.background = themeValue; }

            const accent = ACCENTS[config.themeColor] || ACCENTS['default'];
            document.documentElement.style.setProperty('--accent-color', accent);

            const luminance = getLuminance(currentHex);
            const isDark = luminance < 0.5;
            const body = document.body;
            
            if (isDark) {
                body.style.color = '#F1F5F9';
                document.getElementById('status-badge')?.classList.replace('glass', 'glass-dark');
            } else {
                body.style.color = '#1E293B';
                document.getElementById('status-badge')?.classList.replace('glass-dark', 'glass');
            }
        }

        function toggleView(mode) { 
            config.viewMode = mode; 
            if (mode === 'album') startAlbum(); else stopAlbum();
            renderContent(); 
            saveToLocal(); 
        }

        async function renderContent() {
            const container = document.getElementById('content-display-area');
            const titleEl = document.getElementById('right-title');
            const subtitleEl = document.getElementById('right-subtitle');
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const subtitleMap = { 'rules': 'CLASS RULES', 'notice': 'NOTICE BOARD', 'announcements': 'ANNOUNCEMENTS', 'meal': 'SCHOOL MEALS', 'album': 'CLASS ALBUM' };

            ['rules', 'notice', 'announcements', 'meal', 'album'].forEach(m => {
                const btn = document.getElementById(`btn-view-${m}`);
                if(btn) {
                    btn.className = (config.viewMode === m) 
                        ? "px-5 py-2.5 rounded-lg font-black transition-all text-sm dynamic-accent-bg text-white shadow-lg" 
                        : "px-5 py-2.5 rounded-lg font-bold transition-all text-sm opacity-60 hover:opacity-100";
                }
            });

            subtitleEl.innerText = subtitleMap[config.viewMode] || 'SMART DASHBOARD';

            if (config.viewMode === 'album') {
                titleEl.innerText = "ìš°ë¦¬ ë°˜ ì•¨ë²”"; 
                if (albumPhotos.length === 0) {
                    container.innerHTML = `<div class="glass p-10 rounded-[3rem] h-full flex flex-col items-center justify-center opacity-50"><i data-lucide="images" class="w-20 h-20 mb-4"></i><p class="text-xl font-bold">í™˜ê²½ ì„¤ì •ì—ì„œ ì‚¬ì§„ í´ë” ë˜ëŠ” íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p></div>`;
                } else {
                    container.innerHTML = `<div class="w-full h-full flex items-center justify-center overflow-hidden"><img id="album-image" src="${albumPhotos[albumIdx]}" class="max-w-full max-h-full object-contain"></div>`;
                }
            } else if (config.viewMode === 'meal') {
                titleEl.innerText = "ì˜¤ëŠ˜ì˜ ê¸‰ì‹"; 
                container.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
                const data = await getMealData();
                const formattedDate = `${mealDate.getFullYear()}.${String(mealDate.getMonth()+1).padStart(2,'0')}.${String(mealDate.getDate()).padStart(2,'0')} (${dayNames[mealDate.getDay()]})`;
                let mealHtml = `<div class="glass p-8 rounded-[3rem] shadow-xl h-full flex flex-col border-white/50 animate-in fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="changeMealDate(-1)" class="p-2 hover:bg-white/30 rounded-full transition-all"><i data-lucide="chevron-left"></i></button>
                        <span class="text-2xl font-black">${formattedDate}</span>
                        <button onclick="changeMealDate(1)" class="p-2 hover:bg-white/30 rounded-full transition-all"><i data-lucide="chevron-right"></i></button>
                    </div>`;
                if (data) {
                    const menus = data.DDISH_NM.split('<br/>').map(m => m.replace(/\([0-9.]+\)/g, '').trim());
                    mealHtml += `<div class="flex-1 grid grid-cols-2 gap-4">
                        ${menus.map(m => `<div class="p-4 bg-white/40 rounded-2xl font-bold text-xl">${m}</div>`).join('')}
                    </div><div class="mt-4 text-right dynamic-accent-text font-bold">${data.CAL_INFO}</div>`;
                } else {
                    mealHtml += `<div class="flex-1 flex items-center justify-center opacity-40"><p class="text-xl font-bold">ì‹ë‹¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>`;
                }
                mealHtml += `</div>`; container.innerHTML = mealHtml;
            } else if (config.viewMode === 'notice') {
                titleEl.innerText = "ì•Œë¦¼ì¥"; 
                const ymdKey = noticeDate.toISOString().split('T')[0];
                const formattedDate = `${noticeDate.getFullYear()}.${String(noticeDate.getMonth()+1).padStart(2,'0')}.${String(noticeDate.getDate()).padStart(2,'0')} (${dayNames[noticeDate.getDay()]})`;
                container.innerHTML = `<div class="glass p-8 rounded-[3rem] shadow-xl h-full flex flex-col border-white/50 animate-in fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="changeNoticeDate(-1)" class="p-2 hover:bg-white/30 rounded-full transition-all"><i data-lucide="chevron-left"></i></button>
                        <span class="text-2xl font-black">${formattedDate}</span>
                        <button onclick="changeNoticeDate(1)" class="p-2 hover:bg-white/30 rounded-full transition-all"><i data-lucide="chevron-right"></i></button>
                    </div><textarea id="notice-textarea" class="text-slate-800" oninput="saveNoticeForDate(this.value)" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">${config.notices[ymdKey] || ''}</textarea></div>`;
            } else {
                const type = config.viewMode === 'rules' ? 'rules' : 'announcements';
                titleEl.innerText = type === 'rules' ? "ìš°ë¦¬ ë°˜ ì•½ì†" : "ê³µì§€ì‚¬í•­"; 
                let html = `<div class="space-y-4">`;
                config[type].forEach((item, idx) => {
                    html += `<div class="glass p-6 rounded-[2rem] flex items-center gap-6 group">
                        <span class="text-4xl font-black opacity-10">${String(idx + 1).padStart(2, '0')}</span>
                        <div class="flex-1">
                            <input type="text" value="${item.title}" oninput="config['${type}'][${idx}].title = this.value; saveToLocal();" class="editable-input text-2xl font-black" placeholder="ì œëª©">
                            <input type="text" value="${item.desc}" oninput="config['${type}'][${idx}].desc = this.value; saveToLocal();" class="editable-input text-lg font-bold opacity-70" placeholder="ë‚´ìš©">
                        </div>
                        <button onclick="config['${type}'].splice(${idx}, 1); renderContent(); saveToLocal();" class="p-2 text-red-400 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="trash-2"></i></button>
                    </div>`;
                });
                html += `<button onclick="config['${type}'].push({title:'', desc:''}); renderContent(); saveToLocal();" class="w-full py-5 border-4 border-dashed border-white/40 rounded-[2rem] text-slate-400 font-black hover:bg-white/20 transition-all">+ ì¶”ê°€í•˜ê¸°</button></div>`;
                container.innerHTML = html;
            }
            lucide.createIcons();
        }

        function changeMealDate(days) { mealDate.setDate(mealDate.getDate() + days); renderContent(); }
        function changeNoticeDate(days) { noticeDate.setDate(noticeDate.getDate() + days); renderContent(); }
        function saveNoticeForDate(val) { const ymd = noticeDate.toISOString().split('T')[0]; config.notices[ymd] = val; saveToLocal(); showAutoSaveIndicator(); }

        async function fetchNEIS(endpoint, params) { const q = new URLSearchParams({ Type:'json', KEY:NEIS_API_KEY, ...params }); const r = await fetch(`${NEIS_BASE_URL}/${endpoint}?${q}`); return await r.json(); }
        async function getMealData() {
            if (!config.schoolInfo) return null;
            const ymd = mealDate.getFullYear() + String(mealDate.getMonth() + 1).padStart(2, '0') + String(mealDate.getDate()).padStart(2, '0');
            try { const data = await fetchNEIS('mealServiceDietInfo', { ATPT_OFCDC_SC_CODE: config.schoolInfo.atptCode, SD_SCHUL_CODE: config.schoolInfo.schulCode, MLSV_YMD: ymd }); return data.mealServiceDietInfo ? data.mealServiceDietInfo[1].row[0] : null; } 
            catch (e) { return null; }
        }

        async function searchSchoolInSettings() {
            const r = document.getElementById('region-select').value; const n = document.getElementById('school-name-search').value.trim(); if(!n) return;
            const res = document.getElementById('school-search-results'); res.innerHTML='<div class="text-sm p-3">ê²€ìƒ‰ ì¤‘...</div>';
            try { 
                const d = await fetchNEIS('schoolInfo', { ATPT_OFCDC_SC_CODE:r, SCHUL_NM:n });
                if(d.schoolInfo) {
                    res.innerHTML = d.schoolInfo[1].row.map(s => `
                        <button onclick="selectSchool('${s.ATPT_OFCDC_SC_CODE}', '${s.SD_SCHUL_CODE}', '${s.SCHUL_NM}')" class="w-full text-left p-3 border rounded-xl hover:bg-blue-50 transition-colors">
                            <div class="text-sm font-bold text-slate-800">${s.SCHUL_NM}</div>
                            <div class="text-[11px] text-slate-400 mt-0.5">${s.ORG_RDNMA || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</div>
                        </button>
                    `).join('');
                }
                else res.innerHTML = '<div class="text-sm p-3 text-slate-800">ê²°ê³¼ ì—†ìŒ</div>';
            } catch(e){ res.innerHTML = '<div class="text-sm p-3 text-red-500">ì˜¤ë¥˜ ë°œìƒ</div>'; }
        }
        function selectSchool(atpt, schul, name) { config.tempSchool = { atptCode:atpt, schulCode:schul, schulNm:name }; document.getElementById('selected-school-info').innerText=`âœ… ì„ íƒë¨: ${name}`; }

        function generateDefaultSchedule(startTime, lunchAfter = 4) {
            const [h, m] = startTime.split(':').map(Number); let current = h * 60 + m;
            const format = (min) => `${String(Math.floor(min/60)).padStart(2,'0')}:${String(min%60).padStart(2,'0')}`;
            let sch = [{ name: 'ì•„ì¹¨ììŠµ', start: '08:30', end: format(current) }];
            for(let i=1; i<=6; i++) {
                sch.push({ name: `${i}êµì‹œ`, start: format(current), end: format(current+40) }); current += 40;
                if (i == lunchAfter) { sch.push({ name: 'ì ì‹¬ ì‹œê°„', start: format(current), end: format(current+50) }); current += 50; } 
                else if (i < 6) { sch.push({ name: 'ì‰¬ëŠ” ì‹œê°„', start: format(current), end: format(current+10) }); current += 10; }
            }
            return sch;
        }

        function renderScheduleEditor(schArray) {
            const ed = document.getElementById('schedule-editor'); if(!ed) return;
            ed.innerHTML = schArray.map(s => `<div class="flex flex-col gap-2 border p-4 rounded-xl bg-white schedule-item-row"><span class="font-bold text-sm text-slate-400 uppercase sch-name">${s.name}</span><div class="flex items-center gap-2"><input type="text" value="${s.start}" class="sch-start-in w-full p-2 border rounded-lg text-lg font-black text-center text-slate-800"><span>~</span><input type="text" value="${s.end}" class="sch-end-in w-full p-2 border rounded-lg text-lg font-black text-center text-slate-800"></div></div>`).join('');
        }

        function autoCalculateSchedule(st, la) { renderScheduleEditor(generateDefaultSchedule(st || "09:00", parseInt(la))); }

        function openSettings() {
            const modal = document.getElementById('settings-modal');
            if (modal) modal.style.display = 'flex'; 
            
            document.getElementById('lunch-after-input').value = config.lunchAfter || 4; 
            document.getElementById('album-interval-input').value = config.albumIntervalSeconds || 5;

            document.getElementById('title-text-input').value = config.titleConfig.text || 'Happy Class';
            document.getElementById('title-font-input').value = config.titleConfig.font || '"Pretendard Variable", Pretendard';
            document.getElementById('title-size-input').value = config.titleConfig.size || '6xl';
            document.getElementById('title-color-input').value = config.titleConfig.color || '#6366f1';
            document.getElementById('title-sync-checkbox').checked = config.titleConfig.syncWithTheme;
            toggleTitleColorPicker(config.titleConfig.syncWithTheme);

            const de = document.getElementById('dday-editor'); de.innerHTML = '';
            config.ddays.forEach(d => addRow('dday-editor', d.text, d.date)); 
            const f = config.schedule.find(s => s.name === '1êµì‹œ'); if (f) document.getElementById('start-time-trigger').value = f.start;
            document.getElementById('selected-school-info').innerText = config.schoolInfo ? `âœ… í˜„ì¬: ${config.schoolInfo.schulNm}` : "";
            if (config.themeColor === 'custom') { document.getElementById('color-custom').style.backgroundColor = config.customColor; document.getElementById('custom-color-input').value = config.customColor; }
            renderPeriodSelectors(); renderScheduleEditor(config.schedule); updateColorSelectionUI(); lucide.createIcons();
        }

        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        function handleOutsideClick(e) { if (e.target.id === 'settings-modal') closeSettings(); }

        function saveSettings() {
            config.lunchAfter = parseInt(document.getElementById('lunch-after-input').value); 
            config.albumIntervalSeconds = parseInt(document.getElementById('album-interval-input').value) || 5;

            config.titleConfig = {
                text: document.getElementById('title-text-input').value,
                font: document.getElementById('title-font-input').value,
                size: document.getElementById('title-size-input').value,
                color: document.getElementById('title-color-input').value,
                syncWithTheme: document.getElementById('title-sync-checkbox').checked
            };

            if(config.tempSchool) { config.schoolInfo = config.tempSchool; delete config.tempSchool; }
            const dt = document.querySelectorAll('.dday-title-in'); const dd = document.querySelectorAll('.dday-date-in'); config.ddays = [];
            dt.forEach((t, i) => { if (t.value.trim() && dd[i].value) config.ddays.push({ text: t.value, date: dd[i].value }); });
            config.dailyPeriods = { 1: parseInt(document.getElementById('period-mon').value), 2: parseInt(document.getElementById('period-tue').value), 3: parseInt(document.getElementById('period-wed').value), 4: parseInt(document.getElementById('period-thu').value), 5: parseInt(document.getElementById('period-fri').value) };
            const sRows = document.querySelectorAll('.schedule-item-row'); config.schedule = [];
            sRows.forEach(r => { config.schedule.push({ name: r.querySelector('.sch-name').innerText, start: r.querySelector('.sch-start-in').value, end: r.querySelector('.sch-end-in').value }); });
            
            saveToLocal(); 
            applyBackground(); 
            applyTitleConfig(); 
            renderContent(); 
            updateTime(); 
            
            if (config.viewMode === 'album') startAlbum();

            closeSettings(); 
            showAutoSaveIndicator();
        }

        function saveToLocal() { localStorage.setItem('happy_class_config_v3_44', JSON.stringify(config)); }
        function showAutoSaveIndicator() { const i = document.getElementById('auto-save-indicator'); if(i) { i.style.opacity = '1'; setTimeout(() => { i.style.opacity = '0'; }, 1000); } }

        function renderPeriodSelectors() {
            ['mon', 'tue', 'wed', 'thu', 'fri'].forEach((day, idx) => {
                const select = document.getElementById(`period-${day}`); if (!select) return;
                let options = ''; for (let i = 4; i <= 6; i++) { const selected = config.dailyPeriods[idx + 1] == i ? 'selected' : ''; options += `<option value="${i}" ${selected}>${i}</option>`; }
                select.innerHTML = options;
            });
        }

        function addRow(id, t="", d="") {
            const e = document.getElementById(id); const r = document.createElement('div'); r.className = "flex gap-3 items-center dday-row text-slate-800";
            r.innerHTML = `<input type="text" value="${t}" class="dday-title-in flex-1 p-3 border rounded-xl text-base font-bold bg-white" placeholder="ì¼ì • ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"><input type="date" value="${d}" class="dday-date-in p-3 border rounded-xl text-base font-bold bg-white"><button onclick="this.parentElement.remove()" class="p-3 text-red-400 hover:bg-red-50 rounded-xl transition-colors"><i data-lucide="trash-2" class="w-6 h-6"></i></button>`;
            e.appendChild(r); lucide.createIcons();
        }

        window.onload = init;
    </script>
</body>
</html>
